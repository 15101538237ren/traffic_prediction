{% extends "base.html" %}
{% load static from staticfiles %}
{% block title %}事故预测结果对比{% endblock %}
{% block head %}
    <script type="text/javascript" src="{% static "js/echarts.js" %}"></script>
    <script type="text/javascript">
    var myChart, option, myModal, datetime_list, grid_boundaries, real_frequency, predicted_frequency;

    function submit_form()
    {
        $.ajaxSetup({
            dataType: "json",
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
            },
        });

        var params=$('#form_to_submit').serialize();

        $.ajax({
            type: "POST",
            url: "{% url 'visualize:predicted_line_chart' %}",
            data: params,
            success: function (result) {
                if (result["code"] == 0) {
                $.get(result["option_addr"]).done(function (option_obj) {option = option_obj;});
                $.get(result["addr"]).done(function (json_obj) {
                    datetime_list = json_obj.datetime_str_list;
                    grid_boundaries = json_obj.grid_boundaries;
                    real_frequency = json_obj.real_frequency;
                    predicted_frequency = json_obj.predicted_frequency;
                    draw_grid_boundaries();
                    });
            }
            else {
                alert(result.message);
            }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.table([{
                    "错误类型": jqXHR,
                    "错误信息": textStatus,
                    "http状态": errorThrown
                }])
            }
        });

    }
    </script>
{% endblock %}
{% block content %}
    <div class="container">
    <div class="form-inline" role="form">
        <form id = "form_to_submit" class="form-inline"  action="" method="POST">
        <div class="form-group">
            <label for="time_period" class="control-label"><small>时间周期:</small></label>
            <select id="time_period" class="form-control input-sm" name="time_period" style="width:70px;">
                  {% for k, v in time_period.items %}
                      {% ifequal forloop.counter0 0 %}
                          <option value="{{ v }}" selected="selected">{{ k }}</option>
                      {% else %}
                           <option value="{{ v }}">{{ k }}</option>
                      {% endifequal %}
                  {% endfor %}
            </select>
       </div>
        <div class="form-group">
            <label for="time_segment" class="control-label"><small>时间段:</small></label>
            <select id="time_segment" class="form-control input-sm" name="time_segment" style="width:120px;">
                  {% for k, v in time_segment.items %}
                      {% ifequal forloop.counter0 0 %}
                          <option value="{{ v }}" selected="selected">{{ k }}</option>
                      {% else %}
                           <option value="{{ v }}">{{ k }}</option>
                      {% endifequal %}
                  {% endfor %}
            </select>
       </div>
        <div class="form-group">
            <label for="classifier_name" class="control-label"><small>模型:</small></label>
            <select id="classifier_name" class="form-control input-sm" name="classifier_name" style="width:70px;">
                  {% for v in classifier_names %}
                      {% ifequal forloop.counter0 0 %}
                          <option value="{{ v }}" selected="selected">{{ v }}</option>
                      {% else %}
                           <option value="{{ v }}">{{ v }}</option>
                      {% endifequal %}
                  {% endfor %}
            </select>
       </div>
        <div class="form-group">
            <label for="seq_len" class="control-label"><small>序列长度:</small></label>
            <select id="seq_len" class="form-control input-sm" name="seq_len" style="width:70px;">
                  {% for v in seq_lens %}
                      {% ifequal forloop.counter0 0 %}
                          <option value="{{ v }}" selected="selected">{{ v }}</option>
                      {% else %}
                           <option value="{{ v }}">{{ v }}</option>
                      {% endifequal %}
                  {% endfor %}
            </select>
       </div>
        <div class="form-group">
                <input onclick="submit_form()" class="btn btn-primary btn-sm"  style="width: 80px;" value="查询"/>
                {% csrf_token %}
        </div>
        </form>
        </div>
    </div>
    <div id="allmap">
    </div>

    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" style="width: 1200px; height: 1000px">
	    <div class="modal-dialog" id="modal_dialog" style="width: 1200px; height: 1000px">
            <div class="modal-content" id = "modal_content" style="width: 1200px; height: 1000px">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden='true'>
                        &times;
                    </button>
                </div>
                <div class="modal-body" id="modal_body" style="width: 1200px; height: 800px">
                    <div id="echart_body" class="modal_inner_size" style="width: 1200px; height: 800px; display: none">

                    </div>
                </div>
            </div>
			<div class="modal-footer"></div>
		</div><!-- /.modal-content -->
	</div><!-- /.modal -->
{% endblock %}
{% block endscript %}
<script type="text/javascript">
    myModal = $("#myModal");
    myChart = echarts.init(document.getElementById('echart_body'));
	// 百度地图API功能
	var map = new BMap.Map("allmap");
	map.centerAndZoom(new BMap.Point(116.404, 39.915), 13);     // 初始化地图,设置中心点坐标和地图级别

    $('#datetimepicker').datetimepicker({
        language:'zh-CN',
        autoclose:1,
        minuteStep:1});

    function draw_grid_boundaries() {
        map.clearOverlays();
        for (var i = 0; i < grid_boundaries.length; i++  ) {
            var min_lng = grid_boundaries[i][0];
            var max_lng = grid_boundaries[i][1];
            var min_lat = grid_boundaries[i][2];
            var max_lat = grid_boundaries[i][3];

            var polygon = new BMap.Polygon([
                new BMap.Point(min_lng, min_lat),
                new BMap.Point(max_lng, min_lat),
                new BMap.Point(max_lng, max_lat),
                new BMap.Point(min_lng, max_lat)
            ], {
                strokeColor: "red",
                strokeWeight: 1,
                strokeOpacity: 1,
                fillColor: "rgba(255,255,255,0.2)",
                fillOpacity: 0.5
            });
            polygon.idx = i;
            polygon.addEventListener("click", function () {
                option.xAxis[0].data = datetime_list;
                option.series[0].data = real_frequency[this.idx];
                option.series[1].data = predicted_frequency[this.idx];
                myChart.setOption(option);
                $("#echart_body").css('display','block');
                myModal.modal('show');
            });
           map.addOverlay(polygon);
        }
    }
</script>

{% endblock %}