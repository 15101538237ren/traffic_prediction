{% extends "base.html" %}
{% load static from staticfiles %}
{% block title %}频率时间线{% endblock %}
{% block head %}
    <script type="text/javascript">
    var datetime_list;
    function get_datetime(idx)
    {
        return datetime_list[idx];
    }

    function loadScript(url) {
        var script = document.createElement("script");
        script.type = "text/javascript";
        script.src = url;
        document.body.appendChild(script);
    }

    function submit_form()
    {
        $.ajaxSetup({
            dataType: "json",
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
            },
        });
        var params=$('#form_to_submit').serialize();
        $.ajax({
            type: "POST",
            url: "{% url 'visualize:freqency_timeline' %}",
            data: params,
            success: function (result) {
                if (result["code"] == 0) {
                $.get(result["addr"]).done(function (json_obj) {
                    datetime_list = json_obj.datetime_list;
                    var $slider3=$("<div id='slider3'></div>");
                    $("#slider_div").append($slider3);

                    if ($slider3.length > 0) {
                      $slider3.slider({
                        min: 0,
                        max: json_obj.slider_cnts,
                        values: 0,
                        orientation: "horizontal",
                        range: "min",
                        slide: function(event, ui) {
                          $("#datetimepicker").val(get_datetime(ui.value));
                        }
                      });
                    }
                    $("#slider_div").show();
                    var freq_marix = frequency_matrix;
                    redraw_freqency(freq_marix);
                    });
            }
            else {
                alert(result.message);
            }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.table([{
                    "错误类型": jqXHR,
                    "错误信息": textStatus,
                    "http状态": errorThrown
                }])
            }
        });

    }
    </script>
{% endblock %}
{% block content %}
    <div class="container">
    <div class="form-inline" role="form">
        <form id = "form_to_submit" class="form-inline"  action="" method="POST">
        <div class="form-group">
            <label for="time_period" class="control-label"><small>时间周期:</small></label>
            <select id="time_period" class="form-control input-sm" name="time_period" style="width:70px;">
                  {% for k, v in time_period.items %}
                      {% ifequal forloop.counter0 0 %}
                          <option value="{{ v }}" selected="selected">{{ k }}</option>
                      {% else %}
                           <option value="{{ v }}">{{ k }}</option>
                      {% endifequal %}
                  {% endfor %}
            </select>
       </div>
        <div class="form-group">
            <label for="time_segment" class="control-label"><small>时间段:</small></label>
            <select id="time_segment" class="form-control input-sm" name="time_segment" style="width:120px;">
                  {% for k, v in time_segment.items %}
                      {% ifequal forloop.counter0 0 %}
                          <option value="{{ v }}" selected="selected">{{ k }}</option>
                      {% else %}
                           <option value="{{ v }}">{{ k }}</option>
                      {% endifequal %}
                  {% endfor %}
            </select>
       </div>
        <div class="form-group">
                <input onclick="submit_form()" class="btn btn-primary btn-sm"  style="width: 80px;" value="查询"/>
                {% csrf_token %}
        </div>
        </form>
        <div class="form-group" id="slider_div" style="display: none">
            <label for="dt_query" >请滑动下方滑动条, 改变日期:</label>
            <input type="text" class="form-control form-date input-sm" value="{{ date_start }}" style="width: 180px;"  id="datetimepicker" data-date-format="yyyy-mm-dd hh:ii:ss">
        </div>
        </div>
    </div>
	<div id="allmap">

    </div>
{% endblock %}
{% block endscript %}
<script type="text/javascript">

	// 百度地图API功能
	var map = new BMap.Map("allmap");
	map.centerAndZoom(new BMap.Point(116.404, 39.915), 13);     // 初始化地图,设置中心点坐标和地图级别
    map.enableScrollWheelZoom();                        //启用滚轮放大缩小
    var top_left_control = new BMap.ScaleControl({anchor: BMAP_ANCHOR_BOTTOM_LEFT});// 左上角，添加比例尺
	var top_left_navigation = new BMap.NavigationControl({anchor: BMAP_ANCHOR_BOTTOM_LEFT});  //左上角，添加默认缩放平移控件
    map.addControl(top_left_control);
    map.addControl(top_left_navigation);
    map.enableKeyboard();
    $('#datetimepicker').datetimepicker({
        language:'zh-CN',
        autoclose:1,
        minuteStep:1});
    function redraw_freqency(freq_marix) {
        map.clearOverlays();
    }
</script>

{% endblock %}